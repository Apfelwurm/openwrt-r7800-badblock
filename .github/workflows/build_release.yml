name: openwrt_R7800_build

on:
  schedule:
    # * is a special character in YAML so you have to quote this string
    - cron:  '30 14 * * *'
  push:
    branches: 
    - main
    paths:
    - '**'
    - '!README.md'
  pull_request:
    branches: 
    - main
    paths:
    - '**'
    - '!README.md'

jobs:
  build:
    strategy:
      matrix:
        badblocks: [1, 2, 3, 4]
    runs-on: ubuntu-latest
    steps:
    - uses: AutoModality/action-clean@v1
    - name: checkout
      uses: actions/checkout@v2
    - name: install prereqs
      run: sudo apt-get update -y; sudo apt-get install --no-install-recommends -y git make flex gawk grep libc-dev libz-dev perl python3 rsync subversion unzip build-essential wget python file libncurses-dev python3-pip; pip install lastversion
    - name: check openwrt lastversion
      id: openwrt_version
      run: echo "::set-output name=version::$(lastversion https://github.com/openwrt/openwrt)"    
    - name: check local openwrt lastversion
      id: local_openwrt_version 
      run: echo "::set-output name=version::$(lastversion https://github.com/Apfelwurm/openwrt-r7800-badblock)"  
    - name: checkout openwrt
      if: ${{ steps.openwrt_version.outputs.version != steps.local_openwrt_version.outputs.version }}
      uses: actions/checkout@v2
      with:
        repository: https://github.com/openwrt/openwrt
        path: 'openwrt'
        ref: ${{steps.openwrt_version.outputs.version}}
    - name: updatefeeds
      run: ./scripts/feeds update
      working-directory: ./openwrt
    - name: installfeeds
      run: ./scripts/feeds install -a
      working-directory: ./openwrt
    - name: newconfig
      run: "echo 'CONFIG_TARGET_ipq806x=y\nCONFIG_TARGET_ipq806x_generic=y\nDEVICE_netgear_r7800=y\nCONFIG_SIGNED_PACKAGES=y\n' >> .config"
      working-directory: ./openwrt 
    - name: newconfig
      run: make defconfig
      working-directory: ./openwrt
    - name: patch device
      run: git apply ../${{matrix.badblocks}}_Badblock.patch
      working-directory: ./openwrt    
    - name: build openwrt  
      run: make -j$(nproc) V=sc
      working-directory: ./openwrt 
    - name: move image  
      run: mv bin/targets/ipq806x/generic/openwrt-ipq806x-generic-netgear_r7800-squashfs-nand-factory.bin ../openwrt-${{ steps.openwrt_version.outputs.version }}-ipq806x-generic-netgear_r7800-${{matrix.badblocks}}_badblocks-squashfs-nand-factory.bin
      working-directory: ./openwrt 
    - name: move image  
      run: mv bin/targets/ipq806x/generic/openwrt-ipq806x-generic-netgear_r7800-squashfs-nand-sysupgrade.bin ../openwrt-${{ steps.openwrt_version.outputs.version }}-ipq806x-generic-netgear_r7800-${{matrix.badblocks}}_badblocks-squashfs-nand-sysupgrade.bin
      working-directory: ./openwrt 
    - name: remove openwrt
      run: rm -rf openwrt
    - name: make release
      if: ${{ steps.openwrt_version.outputs.version != steps.local_openwrt_version.outputs.version }}
      uses: softprops/action-gh-release@v1
      with:
        name: ${{ steps.openwrt_version.outputs.version }}
        tag_name: ${{ steps.openwrt_version.outputs.version }}
        files: |
          ./openwrt*.bin
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}   